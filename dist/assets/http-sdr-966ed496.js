import{d as Z,t as ne,a as y,m as $,s as oe,l as le,f as E,w as x,g as ve}from"./index-9251b6ee.js";function C(e,n,r){r+=(r+1)%2;for(var a=n/e,t=new Float32Array(r),l=Math.floor(r/2),o=0,v=0;v<r;++v){var u;v==l?u=2*Math.PI*a:(u=Math.sin(2*Math.PI*a*(v-l))/(v-l),u*=.54-.46*Math.cos(2*Math.PI*v/(r-1))),o+=u,t[v]=u}for(var v=0;v<r;++v)t[v]/=o;return t}function ue(e,n){e+=(e+1)%2;for(var r=Math.floor(e/2),a=new Float32Array(e),t=0;t<a.length;++t)t%2==0&&(a[t]=2/(Math.PI*(r-t)));return a}function U(e){var n=e,r=n.length-1,a=Math.floor(n.length/2),t=new Float32Array(r);function l(u){var f=new Float32Array(u.length+r);f.set(t.subarray(t.length-r)),f.set(u,r),t=f}function o(u){for(var f=0,d=0;d<n.length;++d)f+=n[d]*t[u+d];return f}function v(u){return t[u+a]}return{get:o,loadSamples:l,getDelayed:v}}function b(e,n,r){var a=new U(r),t=e/n;function l(o){a.loadSamples(o);for(var v=new Float32Array(Math.floor(o.length/t)),u=0,f=0;u<v.length;++u,f+=t)v[u]=a.get(Math.floor(f));return v}return{downsample:l}}function fe(e,n,r,a,t){var l=C(e,1e4,t),o=new b(e,n,l),v=new b(e,n,l),u=ue(t),f=new U(u),d=new U(u),w=C(n,r,t),c=new U(w),A=a?-1:1,F=new Q(n*5),T=new Q(n*.5),D=e/n,g=0;function i(P,s){var p=o.downsample(P),M=v.downsample(s),h=0,q=0;f.loadSamples(p),d.loadSamples(M);for(var L=new Float32Array(p.length),m=0;m<L.length;++m)L[m]=f.getDelayed(m)+d.get(m)*A;c.loadSamples(L);for(var _=new Float32Array(p.length),m=0;m<_.length;++m){var B=c.get(m),J=B*B;q+=J;var re=T.add(J),ae=F.add(J),te=.9*Math.max(1,Math.sqrt(2/Math.min(1/128,Math.max(ae,re))));_[m]=te*c.get(m);var z=Math.floor(m*D),V=P[z],W=s[z];h+=V*V+W*W}return g=q/h,_}function S(){return g}return{demodulateTuned:i,getRelSignalPower:S}}function de(e,n,r,a){var t=C(e,r,a),l=new b(e,n,t),o=new b(e,n,t),v=e/n,u=0;function f(w,c){for(var A=l.downsample(w),F=o.downsample(c),T=j(A),D=j(F),g=new Float32Array(A.length),i=0,S=0,P=0,s=0;s<g.length;++s){var p=A[s]-T,M=F[s]-D,h=p*p+M*M,q=Math.sqrt(h);g[s]=q;var L=Math.floor(s*v),m=w[L],_=c[L];i+=m*m+_*_,S+=h,P+=q}for(var B=P/g.length,s=0;s<g.length;++s)g[s]=(g[s]-B)/B;return u=S/i,g}function d(){return u}return{demodulateTuned:f,getRelSignalPower:d}}function ee(e,n,r,a,t){var l=n/(2*Math.PI*r),o=C(e,a,t),v=new b(e,n,o),u=new b(e,n,o),f=0,d=0,w=0;function c(F,T){for(var D=v.downsample(F),g=u.downsample(T),i=new Float32Array(D.length),S=0,P=0,s=0;s<i.length;++s){var p=f*D[s]+d*g[s],M=f*g[s]-D[s]*d,h=1,q=0,L=0,m=1;p<0&&(h=-h,p=-p,q=Math.PI),M<0&&(h=-h,M=-M,q=-q),p>M?m=M/p:p!=M&&(L=-Math.PI/2,m=p/M,h=-h),i[s]=q+h*(L+m/(.9841915835861736+m*(.0934857026296713+m*.19556307900617517)))*l,f=D[s],d=g[s];var _=S-i[s];P+=_*_,S=i[s]}return w=1-Math.sqrt(P/i.length),i}function A(){return w}return{demodulateTuned:c,getRelSignalPower:A}}function se(e,n){for(var r=400,a=new Float32Array(8001),t=new Float32Array(8001),l=0,o=1,v=new Q(9999),u=new Q(9999),f=new Q(49999,!0),d=0;d<8001;++d){var w=(n+d/100-40)*2*Math.PI/e;a[d]=Math.sin(w),t[d]=Math.cos(w)}function c(A){for(var F=new Float32Array(A),T=0;T<F.length;++T){var D=v.add(F[T]*l),g=u.add(F[T]*o);F[T]*=l*o*2;var i;D>0?i=Math.max(-4,Math.min(4,g/D)):i=g==0?0:g>0?4:-4;var S=Math.round((i+4)*1e3),P=l*t[S]+o*a[S];o=o*t[S]-l*a[S],l=P,f.add(i*10)}return{found:f.getStd()<r,diff:F}}return{separate:c}}function X(e,n){var r=1/(1+e*n/1e6),a=0;function t(l){for(var o=0;o<l.length;++o)a=a+r*(l[o]-a),l[o]=a}return{inPlace:t}}function Q(e,n){var r=0,a=0;function t(o){return r=(e*r+o)/(e+1),n&&(a=(e*a+(o-r)*(o-r))/(e+1)),r}function l(){return a}return{add:t,getStd:l}}function j(e){for(var n=0,r=0;r<e.length;++r)n+=e[r];return n/e.length}function we(e,n){for(var r=new Uint8Array(e),a=r.length/2,t=new Float32Array(a),l=new Float32Array(a),o=0;o<a;++o)t[o]=r[2*o]/128-.995,l[o]=r[2*o+1]/128-.995;return[t,l]}function ce(e,n,r,a,t){for(var l=Math.cos(2*Math.PI*n/r),o=Math.sin(2*Math.PI*n/r),v=e[0],u=e[1],f=new Float32Array(v.length),d=new Float32Array(u.length),w=0;w<v.length;++w){f[w]=v[w]*a-u[w]*t,d[w]=v[w]*t+u[w]*a;var c=a*o+t*l;a=a*l-t*o,t=c}return[f,d,a,t]}function me(e,n,r){var a=48e3,t=r/2,l=new de(e,a,t,351),o=C(a,1e4,41),v=new b(a,n,o);function u(f,d){var w=l.demodulateTuned(f,d),c=v.downsample(w);return{left:c.buffer,right:new Float32Array(c).buffer,stereo:!1,signalLevel:Math.pow(l.getRelSignalPower(),.17)}}return{demodulate:u}}function G(e,n,r,a){var t=48e3,l=new fe(e,t,r,a,151),o=C(t,1e4,41),v=new b(t,n,o);function u(f,d){var w=l.demodulateTuned(f,d),c=v.downsample(w);return{left:c.buffer,right:new Float32Array(c).buffer,stereo:!1,signalLevel:Math.pow(l.getRelSignalPower(),.17)}}return{demodulate:u}}function ge(e,n,r){var a=1+Math.floor((r-1)*7/75e3),t=48e3*a,l=r*.8,o=new ee(e,t,r,l,Math.floor(50*7/a)),v=C(t,8e3,41),u=new b(t,n,v);function f(d,w){var c=o.demodulateTuned(d,w),A=u.downsample(c);return{left:A.buffer,right:new Float32Array(A).buffer,stereo:!1,signalLevel:o.getRelSignalPower()}}return{demodulate:f}}function K(e,n){var r=336e3,a=75e3,t=a*.8,l=19e3,o=50,v=new ee(e,r,a,t,51),u=C(r,1e4,41),f=new b(r,n,u),d=new b(r,n,u),w=new se(r,l),c=new X(n,o),A=new X(n,o);function F(T,D,g){var i=v.demodulateTuned(T,D),S=f.downsample(i),P=new Float32Array(S),s=!1;if(g){var p=w.separate(i);if(p.found){s=!0;for(var M=d.downsample(p.diff),h=0;h<M.length;++h)P[h]-=M[h],S[h]+=M[h]}}return c.inPlace(S),A.inPlace(P),{left:S.buffer,right:P.buffer,stereo:s,signalLevel:v.getRelSignalPower()}}return{demodulate:F}}var N=1024e3,O=48e3;function he(){var e=new K(N,O),n=1,r=0;function a(l,o,v,u){var f=we(l);f=ce(f,v,N,n,r),n=f[2],r=f[3];var d=e.demodulate(f[0],f[1],o);return[d.left,d.right,d.signalLevel,d.stereo]}function t(l){switch(l){case"AM":e=new me(N,O,6e3);break;case"USB":e=new G(N,O,2700,!0);break;case"LSB":e=new G(N,O,2700,!1);break;case"NFM":e=new ge(N,O,1e4);break;default:e=new K(N,O);break}}return{process:a,setMode:t}}let I=null,Y=null,k=null,R=null;const H=`ws://${location.host}/data`;async function Se(){k=k||new he,Y=ve(),R=null,I=new WebSocket(H),I.binaryType="arraybuffer",Z.value=H;let e=0,n=0;I.addEventListener("open",()=>{e=Date.now(),I.send(JSON.stringify({type:"init"}))}),I.addEventListener("error",()=>R=`Connect to ${H} failed.`),I.addEventListener("close",()=>R=`Stream ${H} closed.`),I.addEventListener("message",({data:r})=>{if(r instanceof ArrayBuffer){if(ne.value+=r.byteLength,e===0||Date.now()-e<1e3)return;const a=r.byteLength-8-4,t=r.slice(0,a);let[l,o,v]=k.process(t,!0,-y.value);l=new Float32Array(l),o=new Float32Array(o),Y.play(l,o,v,$.value==="FM"?.15:v/10),oe(v);const u=new DataView(r),f=u.getFloat64(a),d=u.getUint32(a+8);le.value=Date.now()-f+n,E.value===d&&(v>.5&&y.value!==0?(E.value=E.value+y.value,y.value=0):y.value>0?y.value<3e5?y.value+=1e5:(E.value=E.value+y.value,y.value=1e5):y.value<0&&(y.value>-3e5?y.value-=1e5:(E.value=E.value+y.value,y.value=-1e5)))}else{const a=JSON.parse(r);n=Math.round(a.ts-(e+Date.now())/2+(Date.now()-e)/2),$.value=a.mode,E.value=a.frequency,y.value=a.tuningFreq}})}async function pe(){const e=I;I=null,Z.value="",await new Promise(n=>setTimeout(n,100)),e&&e.close()}async function Me(){for(;I;)if(await new Promise(e=>setTimeout(e,100)),R)throw R}x(E,()=>{I.send(JSON.stringify({type:"frequency",frequency:E.value,tuningFreq:y.value}))});x($,e=>{k.setMode(e),I.send(JSON.stringify({type:"mode",mode:e}))});export{Se as connect,pe as disconnect,Me as receive};
